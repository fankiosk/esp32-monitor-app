<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 æ™ºæ…§åœŸå£¤ç›£æ¸¬èˆ‡æ§åˆ¶</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è¨­å®šå­—é«”ç‚º Interï¼Œä¸¦ç¢ºä¿æ•´é«”ä½ˆå±€èˆ’é© */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7fa; 
            /* *** æ›¿æ›ç‚ºä½¿ç”¨è€…æä¾›çš„æ¨¹è‹—åœ–ç‰‡ä½œç‚ºèƒŒæ™¯ *** */
            background-image: url('uploaded:image_81b3a8.jpg-955dbb97-6266-4051-9254-0ee723736e41');
            background-size: cover;
            background-position: center;
            background-attachment: fixed; /* ç¢ºä¿èƒŒæ™¯åœ¨æ»¾å‹•æ™‚å›ºå®šï¼Œæå‡è¦–è¦ºæ•ˆæœ */
            display: flex; 
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }
        /* è®“æŒ‰éˆ•çš„ç‹€æ…‹è®Šæ›æ›´æ˜é¡¯ */
        .sprinkler-on {
            background-color: #10B981; /* ç¶ è‰² */
            transition: all 0.3s;
        }
        .sprinkler-off {
            background-color: #EF4444; /* ç´…è‰² */
            transition: all 0.3s;
        }
        /* ä¸»å®¹å™¨æ¨£å¼ï¼šå¢åŠ åŠé€æ˜èˆ‡æ¨¡ç³Šæ•ˆæœï¼Œæé«˜å¯è®€æ€§ */
        .app-container {
            background-color: rgba(255, 255, 255, 0.95); /* è¼•å¾®åŠé€æ˜ç™½è‰²ï¼Œç¢ºä¿åœ¨æ˜äº®èƒŒæ™¯ä¸Šæ–‡å­—æ¸…æ™° */
            backdrop-filter: blur(5px); /* è¼•å¾®èƒŒæ™¯æ¨¡ç³Šæ•ˆæœï¼Œç¢ºä¿æ–‡å­—åœ¨åœ–ç‰‡ä¸Šæ¸…æ™° */
        }
    </style>
</head>
<body>

    <!-- ä¸»å®¹å™¨ï¼šæ¨¡æ“¬ App è¦–çª— -->
    <div class="w-full max-w-sm app-container shadow-2xl rounded-2xl p-6">
        <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">
            ğŸŒ± æ™ºæ…§çŒæº‰ä¸­å¿ƒ
        </h1>
        
        <!-- æ–°å¢æ°£å€™é¡¯ç¤ºå€ -->
        <div id="climate-display" class="bg-blue-600 text-white p-4 rounded-xl mb-4 shadow-lg text-center">
            <p class="text-base font-semibold" id="current-location">ä½ç½®: è¼‰å…¥ä¸­...</p>
            <p class="text-xl font-bold" id="current-weather">æ°£å€™: æ­£åœ¨æŸ¥è©¢...</p>
        </div>

        <p class="text-sm text-gray-500 mb-6 text-center">
            ESP32 æº«æ¿•åº¦ç›£æ§èˆ‡ç‘æ°´ç´€éŒ„
        </p>

        <!-- æ•¸æ“šé¡¯ç¤ºå€ -->
        <div id="data-display" class="space-y-4 mb-6">
            <!-- åœŸå£¤æº«åº¦å¡ç‰‡ -->
            <div id="temp-card" class="bg-gradient-to-r from-red-600 to-red-800 text-white p-5 rounded-xl shadow-lg">
                <div class="flex items-center justify-between">
                    <span class="text-lg font-semibold">ğŸŒ¡ï¸ åœŸå£¤æº«åº¦</span>
                    <span id="temperature" class="text-4xl font-extrabold">--.- Â°C</span>
                </div>
            </div>

            <!-- åœŸå£¤æ¿•åº¦å¡ç‰‡ -->
            <div id="humid-card" class="bg-gradient-to-r from-green-500 to-teal-600 text-white p-5 rounded-xl shadow-lg">
                <div class="flex items-center justify-between">
                    <span class="text-lg font-semibold">ğŸ’§ åœŸå£¤æ¿•åº¦</span>
                    <span id="humidity" class="text-4xl font-extrabold">--.- %</span>
                </div>
            </div>
        </div>

        <!-- ç‘æ°´æ§åˆ¶å€ -->
        <div class="bg-gray-100 p-4 rounded-xl mb-6 shadow-inner">
            <h2 class="text-xl font-bold text-gray-800 mb-3 text-center">æ°´é–¥æ§åˆ¶</h2>
            <div class="flex items-center justify-between">
                <span class="font-semibold text-gray-700">ç‹€æ…‹:</span>
                <span id="sprinkler-status" class="px-3 py-1 rounded-full text-sm font-bold">è¼‰å…¥ä¸­...</span>
            </div>
            <button onclick="toggleSprinkler()" id="sprinkler-button" 
                    class="w-full mt-3 py-3 text-white font-semibold rounded-lg shadow-md hover:opacity-90 transition duration-150 active:scale-95 disabled:opacity-50" disabled>
                æ§åˆ¶
            </button>
            <input type="text" id="location-input" placeholder="å˜—è©¦è‡ªå‹•ç²å–ä½ç½®ä¸­..." 
                   class="w-full mt-2 p-2 border border-gray-300 rounded-lg text-sm" required disabled>
        </div>

        <!-- ç‘æ°´ç´€éŒ„å€ -->
        <div class="mt-6">
            <h2 class="text-xl font-bold text-gray-800 mb-3 text-center">æ­·å²ç‘æ°´ç´€éŒ„</h2>
            <ul id="log-list" class="space-y-2 text-sm">
                <li class="text-center text-gray-500">è¼‰å…¥æ­·å²æ•¸æ“š...</li>
            </ul>
        </div>
        
        <!-- ç‹€æ…‹èˆ‡ IP æç¤ºå€ -->
        <div class="mt-6">
            <p id="status-message" class="text-center text-sm text-gray-600 mb-4">é€£ç·šä¸­...</p>

            <button onclick="fetchData()" id="refresh-button" 
                    class="w-full py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 active:scale-95 disabled:bg-indigo-400">
                ğŸ”„ æ‰‹å‹•åˆ·æ–°æ•¸æ“š
            </button>
        </div>

        <!-- IP åœ°å€æç¤º (ä¾›ä½¿ç”¨è€…ä¿®æ”¹) -->
        <p class="mt-4 p-3 bg-yellow-100 text-yellow-800 rounded-lg text-xs">
            <span class="font-bold">âš ï¸ é‡è¦ï¼š</span> è«‹ä¿®æ”¹ç¨‹å¼ç¢¼ä¸­çš„ `ESP32_IP_ADDRESS` è®Šæ•¸ã€‚
            **è«‹ç¢ºä¿æ‚¨çš„ ESP32 ç¨‹å¼ç¢¼å·²æ›´æ–°ä¸¦å·²ä¸Šå‚³ï¼**
        </p>
        <p id="user-id-display" class="mt-2 text-xs text-gray-500 text-center">UserID: è¼‰å…¥ä¸­...</p>
    </div>

    <script type="module">
        // Firebase å°å…¥ (å¿…é ˆä½¿ç”¨ module type)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, orderBy, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('Debug'); // å•Ÿç”¨ Firestore åµéŒ¯æ—¥èªŒ

        // --- 1. å¸¸æ•¸èˆ‡å…¨åŸŸè®Šæ•¸ ---
        // ã€é‡è¦ã€‘è«‹å°‡æ­¤ IP ä½å€æ›¿æ›æˆæ‚¨çš„ ESP32 å¯¦éš›é€£ç·šå¾Œçš„ IP
        const ESP32_IP_ADDRESS = "192.168.1.100"; 
        const API_URL_DATA = `http://${ESP32_IP_ADDRESS}/data`; 
        const API_URL_TOGGLE = `http://${ESP32_IP_ADDRESS}/sprinkler/toggle`; 

        const LOCATION_DEFAULT = "æ¡ƒåœ’å¹³é®"; // é è¨­ä½ç½®
        let userCoordinates = null; 

        // Firebase è®Šæ•¸
        let app, db, auth, userId = null;
        let isAuthReady = false;
        
        // ç‘æ°´é‚è¼¯è®Šæ•¸
        let sprinklerState = false; 
        let wateringStartTime = null; 
        
        // --- 2. DOM å…ƒç´  ---
        const tempElement = document.getElementById('temperature');
        const humidElement = document.getElementById('humidity');
        const statusElement = document.getElementById('status-message');
        const refreshButton = document.getElementById('refresh-button');
        const sprinklerButton = document.getElementById('sprinkler-button');
        const sprinklerStatusDisplay = document.getElementById('sprinkler-status');
        const locationInput = document.getElementById('location-input');
        const logList = document.getElementById('log-list');
        const userIdDisplay = document.getElementById('user-id-display');
        const locationElement = document.getElementById('current-location'); // æ–°å¢
        const weatherElement = document.getElementById('current-weather'); // æ–°å¢
        
        let refreshInterval = null;

        // --- 3. Firebase åˆå§‹åŒ–èˆ‡èªè­‰ ---
        
        function initFirebase() {
            try {
                // å¾ç’°å¢ƒè®Šæ•¸ç²å–é…ç½®
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    console.error("Firebase config is missing or invalid.");
                    statusElement.textContent = "Firebase è¨­å®šéŒ¯èª¤ï¼";
                    return;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // èªè­‰ç›£è½å™¨
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        userIdDisplay.textContent = `UserID: ${userId}`;
                        // èªè­‰æˆåŠŸå¾Œï¼Œé–‹å§‹ç›£è½è³‡æ–™
                        listenToWateringLogs(appId, userId);
                        // å•Ÿç”¨ç‘æ°´æŒ‰éˆ•
                        sprinklerButton.disabled = false;
                    } else {
                        // é¦–æ¬¡ç™»å…¥æˆ–åŒ¿åç™»å…¥
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Firebase Auth Error:", error);
                            statusElement.textContent = "èªè­‰å¤±æ•—ï¼Œç„¡æ³•å„²å­˜ç´€éŒ„ã€‚";
                        }
                    }
                });

                // é¦–æ¬¡å˜—è©¦èªè­‰
                if (!auth.currentUser) {
                    // onAuthStateChanged æœƒè™•ç†ç™»å…¥é‚è¼¯
                }

            } catch (e) {
                console.error("Firebase initialization failed:", e);
                statusElement.textContent = "Firebase å•Ÿå‹•å¤±æ•—ï¼";
            }
        }
        
        // --- 4. ç‘æ°´ç´€éŒ„ Firestore è®€å–/å¯«å…¥ ---

        /**
         * @description ç›£è½ Firestore ä¸­çš„ç‘æ°´ç´€éŒ„ (ç§æœ‰è·¯å¾‘)
         * @param {string} appId - æ‡‰ç”¨ç¨‹å¼ ID
         * @param {string} uid - ä½¿ç”¨è€… ID
         */
        function listenToWateringLogs(appId, uid) {
            // ç§æœ‰è·¯å¾‘: /artifacts/{appId}/users/{userId}/watering_logs
            const logsCollectionRef = collection(db, `artifacts/${appId}/users/${uid}/watering_logs`);
            
            // æŸ¥è©¢æœ€æ–°çš„ 10 ç­†ç´€éŒ„
            const q = query(logsCollectionRef); 

            onSnapshot(q, (snapshot) => {
                logList.innerHTML = ''; // æ¸…ç©ºåˆ—è¡¨
                if (snapshot.empty) {
                    logList.innerHTML = '<li class="text-center text-gray-500 py-2">ç›®å‰æ²’æœ‰ç‘æ°´ç´€éŒ„ã€‚</li>';
                    return;
                }

                snapshot.docs
                    // æ ¹æ“šé–‹å§‹æ™‚é–“é€²è¡Œæ’åº (åœ¨å®¢æˆ¶ç«¯æ’åºï¼Œé¿å… Firestore ç´¢å¼•å•é¡Œ)
                    .sort((a, b) => {
                        const timeA = a.data().startTime?.toMillis() || 0;
                        const timeB = b.data().startTime?.toMillis() || 0;
                        return timeB - timeA; // æœ€æ–°åœ¨æœ€å‰é¢
                    })
                    .slice(0, 10) // åªé¡¯ç¤ºæœ€æ–°çš„ 10 ç­†
                    .forEach((doc) => {
                        const log = doc.data();
                        const startDate = log.startTime ? log.startTime.toDate().toLocaleString('zh-TW') : 'N/A';
                        const durationSeconds = log.durationSeconds ? log.durationSeconds.toFixed(1) : 'N/A';
                        const volumeLiters = log.volumeLiters ? log.volumeLiters.toFixed(2) : 'N/A';
                        const weather = log.weather || 'æœªè¨˜éŒ„';
                        const location = log.location || 'æœªçŸ¥ä½ç½®';

                        const listItem = document.createElement('li');
                        listItem.className = 'bg-white p-3 border border-gray-200 rounded-lg shadow-sm';
                        listItem.innerHTML = `
                            <p class="font-bold text-gray-800">${startDate}</p>
                            <p class="text-xs text-gray-600">æ™‚é•·: <span class="font-mono text-blue-600">${durationSeconds} ç§’</span>, å‡ºæ°´é‡: <span class="font-mono text-blue-600">${volumeLiters} L</span></p>
                            <p class="text-xs text-gray-600">åœ°é»: ${location}</p>
                            <p class="text-xs text-gray-600">å¤©æ°£: ${weather}</p>
                        `;
                        logList.appendChild(listItem);
                        
                        // ä½¿ç”¨æœ€æ–°çš„ç´€éŒ„ä¾†æ›´æ–°æ°£å€™é¡¯ç¤ºå€
                        updateClimateDisplay(location, weather);
                    });
            }, (error) => {
                console.error("Firestore Log Listen Error:", error);
                logList.innerHTML = '<li class="text-center text-red-500 py-2">è¼‰å…¥ç´€éŒ„å¤±æ•—ï¼</li>';
            });
        }
        
        /**
         * @description å¯«å…¥ç‘æ°´çµæŸç´€éŒ„åˆ° Firestore
         * @param {number} durationSeconds - ç‘æ°´æŒçºŒæ™‚é–“ï¼ˆç§’ï¼‰
         * @param {string} location - ä½¿ç”¨è€…è¼¸å…¥çš„ä½ç½®
         */
        async function writeWateringLog(durationSeconds, location) {
            if (!isAuthReady || !db || !userId) {
                console.error("Firestore not ready. Cannot save log.");
                return;
            }

            // 1. æŸ¥è©¢å¤©æ°£ (ä½¿ç”¨ Google Search API)
            let weatherSummary = "å¤©æ°£æŸ¥è©¢å¤±æ•—";
            let weatherQuery;
            let finalLocation = location || LOCATION_DEFAULT; // é è¨­ä½¿ç”¨æ‰‹å‹•è¼¸å…¥æˆ– FALLBACK

            if (userCoordinates) {
                // å¦‚æœæœ‰åº§æ¨™ï¼Œå„ªå…ˆä½¿ç”¨åº§æ¨™æŸ¥è©¢å¤©æ°£
                weatherQuery = `current weather at latitude ${userCoordinates.lat.toFixed(4)} longitude ${userCoordinates.lon.toFixed(4)}`;
                // å°‡ä½ç½®åç¨±è¨˜éŒ„ç‚ºåº§æ¨™
                finalLocation = `Lat: ${userCoordinates.lat.toFixed(4)}, Lon: ${userCoordinates.lon.toFixed(4)}`;
            } else {
                // å¦‚æœæ²’æœ‰åº§æ¨™ï¼Œä½¿ç”¨æ‰‹å‹•è¼¸å…¥çš„åŸå¸‚åç¨±æŸ¥è©¢å¤©æ°£
                // å¦‚æœ location ç‚ºç©ºå­—ä¸²ï¼Œå‰‡æœƒä½¿ç”¨ LOCATION_DEFAULT ("æ¡ƒåœ’å¹³é®")
                weatherQuery = `current weather in ${finalLocation}`;
            }
            
            try {
                // å°‡æŸ¥è©¢ç™¼é€åˆ° Gemini
                weatherSummary = await fetchWeatherFromGoogle(weatherQuery);
                // æˆåŠŸç²å–å¤©æ°£å¾Œï¼Œå³æ™‚æ›´æ–°æ°£å€™é¡¯ç¤ºå€
                updateClimateDisplay(finalLocation, weatherSummary); 
            } catch (e) {
                console.error("Google Search Weather Fetch Failed:", e);
                // å³ä½¿å¤±æ•—ä¹Ÿç¹¼çºŒå„²å­˜ç´€éŒ„
            }
            
            // 2. ä¼°ç®—æ°´é‡ (å‡è¨­æ¯ç§’å‡ºæ°´ 0.05 å‡, å¯è‡ªè¡Œèª¿æ•´)
            const volumeLiters = durationSeconds * 0.05; 
            
            // 3. å¯«å…¥ Firestore
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const logsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/watering_logs`);
                
                await addDoc(logsCollectionRef, {
                    startTime: wateringStartTime || serverTimestamp(), // è¨˜éŒ„é–‹å§‹æ™‚é–“
                    durationSeconds: durationSeconds,
                    volumeLiters: volumeLiters,
                    location: finalLocation, // ä½¿ç”¨æœ€çµ‚çš„ä½ç½®å­—ä¸²
                    weather: weatherSummary,
                    loggedAt: serverTimestamp() // è¨˜éŒ„å„²å­˜æ™‚é–“
                });
                console.log("Watering log successfully written to Firestore.");
            } catch (e) {
                console.error("Error writing document: ", e);
                // ä½¿ç”¨è‡ªå®šç¾©è¨Šæ¯æ¡†æ›¿ä»£ alert()
                showCustomMessage("ç´€éŒ„å„²å­˜å¤±æ•—ï¼šè«‹æª¢æŸ¥ Firebase å®‰å…¨è¦å‰‡å’Œç¶²è·¯é€£ç·šã€‚");
            }
        }
        
        /**
         * @description é€é Google Search API ç²å–å¤©æ°£æ‘˜è¦
         * @param {string} query - æŸ¥è©¢å­—ä¸²
         * @returns {Promise<string>} å¤©æ°£æ‘˜è¦å­—ä¸²
         */
        async function fetchWeatherFromGoogle(query) {
            const systemPrompt = "ä½œç‚ºä¸€å€‹ç°¡æ½”çš„å¤©æ°£åŠ©æ‰‹ï¼Œè«‹æ ¹æ“šæœç´¢çµæœæä¾›ä¸€å€‹ä¸è¶…é 20 å€‹æ¼¢å­—çš„å³æ™‚å¤©æ°£æ‘˜è¦ (åŒ…å«æº«åº¦å’Œå¤©æ°£ç‹€æ³)ã€‚";
            const apiKey = "" // Canvas ç’°å¢ƒæœƒè‡ªå‹•æä¾›
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            // ç‚ºäº†ç¢ºä¿ç¹é«”ä¸­æ–‡å’Œè‹±æ–‡æœç´¢éƒ½èƒ½é€²è¡Œï¼Œæˆ‘å€‘å°‡æŸ¥è©¢èªå¥è½‰æ›ç‚ºç¹é«”ä¸­æ–‡å’Œè‹±æ–‡
            const cnQuery = query.replace('current weather in ', 'ç›®å‰å¤©æ°£ ').replace('current weather at latitude', 'ç›®å‰å¤©æ°£ ç·¯åº¦');

            const payload = {
                contents: [{ parts: [{ text: query }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            // å¦‚æœæŸ¥è©¢ä¸åŒ…å«åº§æ¨™ï¼Œå‰‡ç™¼é€å…©å€‹æŸ¥è©¢ï¼ˆä¸­/è‹±ï¼‰ï¼Œæé«˜æœç´¢æˆåŠŸç‡
            if (!query.includes('latitude')) {
                payload.tools[0].google_search.queries = [query, cnQuery];
            } else {
                // å¦‚æœæ˜¯åº§æ¨™æŸ¥è©¢ï¼Œåªä½¿ç”¨è‹±æ–‡
                payload.tools[0].google_search.queries = [query];
            }


            const maxRetries = 3;
            let delay = 1000;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (text) {
                        return text.trim();
                    } else {
                        return "ç„¡æ•ˆçš„å¤©æ°£æ•¸æ“š";
                    }
                } catch (error) {
                    console.warn(`Weather fetch attempt ${i + 1} failed. Retrying in ${delay / 1000}s...`, error);
                    if (i === maxRetries - 1) {
                        throw new Error("Weather API failed after multiple retries.");
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Exponential backoff
                }
            }
            return "å¤©æ°£æŸ¥è©¢å¤±æ•—"; // Should be unreachable
        }
        
        // --- 5. Geolocation API è™•ç† ---

        /**
         * @description å˜—è©¦ä½¿ç”¨ç€è¦½å™¨ Geolocation API ç²å–ç”¨æˆ¶ä½ç½®ã€‚
         */
        function getGeolocation() {
            if (navigator.geolocation) {
                locationInput.placeholder = 'æ­£åœ¨å˜—è©¦ç²å–æ‚¨çš„ä½ç½®...';
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userCoordinates = {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude
                        };
                        console.log("Geolocation successful:", userCoordinates);
                        
                        const displayLocation = `Lat: ${userCoordinates.lat.toFixed(3)}, Lon ${userCoordinates.lon.toFixed(3)}`;
                        
                        // æˆåŠŸå¾Œé–å®šè¼¸å…¥æ¬„ï¼Œé¡¯ç¤ºåº§æ¨™
                        locationInput.placeholder = `ä½ç½®å·²é–å®š: ${displayLocation}`;
                        locationInput.value = ""; 
                        locationInput.disabled = true; 
                        showCustomMessage("ä½ç½®è‡ªå‹•ç²å–æˆåŠŸï¼Œå°‡ä½¿ç”¨ç²¾ç¢ºåº§æ¨™è¨˜éŒ„å¤©æ°£ã€‚");
                        
                        // æ›´æ–°æ°£å€™é¡¯ç¤ºå€çš„ä½ç½®
                        updateClimateDisplay(displayLocation, null); 
                        
                        // æ¸…é™¤ç‹€æ…‹æç¤º
                        statusElement.textContent = `é€£ç·šä¸­...`;
                    },
                    (error) => {
                        console.error("Geolocation failed:", error);
                        userCoordinates = null;
                        
                        // å®šä½å¤±æ•—æ™‚ï¼Œå°‡è¼¸å…¥æ¬„å•Ÿç”¨ï¼Œä¸¦ä½¿ç”¨æ–°çš„é è¨­å€¼æç¤º
                        locationInput.placeholder = `ç²å–å¤±æ•—ï¼Œå·²é è¨­ç‚ºã€Œ${LOCATION_DEFAULT}ã€ã€‚è«‹æ‰‹å‹•ä¿®æ”¹ã€‚`;
                        locationInput.disabled = false; 
                        locationInput.value = LOCATION_DEFAULT; // å°‡é è¨­å€¼å¡«å…¥è¼¸å…¥æ¡†ï¼Œæ–¹ä¾¿ä½¿ç”¨è€…çœ‹åˆ°
                        
                        // æ›´æ–°æ°£å€™é¡¯ç¤ºå€çš„ä½ç½®ç‚ºé è¨­å€¼
                        updateClimateDisplay(LOCATION_DEFAULT, null);
                        
                        statusElement.textContent = 'é€£ç·šä¸­...'; // æ¢å¾©ç‹€æ…‹æç¤º
                        
                        let errorMessage = `ç²å–ä½ç½®å¤±æ•—ï¼å·²é è¨­ç‚º ${LOCATION_DEFAULT}ã€‚`;
                        if (error.code === error.PERMISSION_DENIED) {
                            errorMessage = "è«‹å…è¨±ç€è¦½å™¨å­˜å–æ‚¨çš„ä½ç½®ä»¥è‡ªå‹•è¨˜éŒ„å¤©æ°£ã€‚";
                        }
                        showCustomMessage(errorMessage);
                    },
                    {
                        enableHighAccuracy: true, // å˜—è©¦ç²å–æœ€ç²¾ç¢ºçš„ä½ç½®
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                locationInput.placeholder = "æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ Geolocation APIï¼Œå·²é è¨­ç‚ºæ¡ƒåœ’å¹³é®ã€‚";
                locationInput.disabled = false;
                locationInput.value = LOCATION_DEFAULT;
                updateClimateDisplay(LOCATION_DEFAULT, null); // æ›´æ–°æ°£å€™é¡¯ç¤ºå€
                showCustomMessage("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ä½ç½®æœå‹™ã€‚");
            }
        }


        // --- 6. ESP32 æ•¸æ“šäº’å‹• (æº«æ¿•åº¦èˆ‡ç‘æ°´ç‹€æ…‹) ---

        /**
         * @description ç²å– ESP32 çš„æº«æ¿•åº¦èˆ‡ç‘æ°´ç‹€æ…‹
         */
        async function fetchData() {
            refreshButton.disabled = true;
            statusElement.textContent = 'ç²å–æ•¸æ“šä¸­...';
            statusElement.classList.remove('text-red-600', 'text-green-600');
            statusElement.classList.add('text-blue-600');
            
            try {
                const response = await fetch(API_URL_DATA);
                const data = await response.json(); 
                
                // --- æ¨¡æ“¬æ•¸æ“šé–‹å§‹ (é è¦½æ™‚ä½¿ç”¨) ---
                /*
                await new Promise(resolve => setTimeout(resolve, 800)); 
                const mockData = {
                    temperature: (15 + Math.random() * 15).toFixed(1),
                    humidity: (20 + Math.random() * 70).toFixed(1),
                    sprinklerState: sprinklerState // ä½¿ç”¨æœ¬åœ°ç‹€æ…‹æ¨¡æ“¬
                };
                const data = mockData;
                */
                // --- æ¨¡æ“¬æ•¸æ“šçµæŸ ---
                
                if (data && data.temperature !== undefined && data.humidity !== undefined) {
                    // æ›´æ–°ç’°å¢ƒæ•¸æ“š
                    tempElement.textContent = `${data.temperature} Â°C`;
                    humidElement.textContent = `${data.humidity} %`;
                    
                    // æ›´æ–°ç‘æ°´ç‹€æ…‹
                    updateSprinklerUI(data.sprinklerState === true);
                    
                    statusElement.textContent = `ä¸Šæ¬¡æ›´æ–°: ${new Date().toLocaleTimeString('zh-TW')}`;
                    statusElement.classList.remove('text-blue-600');
                    statusElement.classList.add('text-green-600');
                } else {
                    throw new Error("Invalid data format received.");
                }

            } catch (error) {
                console.error("Fetch error:", error);
                tempElement.textContent = "--.- Â°C";
                humidElement.textContent = "--.- %";
                updateSprinklerUI(false, true); // é¡¯ç¤ºéŒ¯èª¤ç‹€æ…‹
                statusElement.textContent = 'é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ ESP32 ç¶²è·¯å’Œ IPã€‚';
                statusElement.classList.remove('text-blue-600', 'text-green-600');
                statusElement.classList.add('text-red-600');
            } finally {
                refreshButton.disabled = false;
            }
        }
        
        /**
         * @description é€é API å‘¼å« ESP32 æ›´æ”¹ç‘æ°´ç‹€æ…‹
         */
        async function toggleSprinkler() {
            if (sprinklerButton.disabled) return;
            
            const location = locationInput.value.trim();
            
            // åªæœ‰åœ¨ç‘æ°´é—œé–‰ç‹€æ…‹ AND æ²’æœ‰åº§æ¨™ AND æ²’æœ‰æ‰‹å‹•è¼¸å…¥æ™‚æ‰æç¤º
            if (!sprinklerState && !userCoordinates && location.length < 2) { 
                showCustomMessage("è«‹åœ¨é–‹å•Ÿç‘æ°´å‰è¼¸å…¥ä¸€å€‹æœ‰æ•ˆçš„åŸå¸‚æˆ–ä½ç½®åç¨±ï¼");
                return;
            }

            sprinklerButton.disabled = true;
            
            try {
                // å‘¼å« ESP32 API é€²è¡Œåˆ‡æ›
                const response = await fetch(API_URL_TOGGLE, { method: 'POST' });
                
                if (!response.ok) throw new Error("ESP32 API failed to toggle.");
                
                // å‡è¨­ ESP32 æˆåŠŸåˆ‡æ›
                const newState = !sprinklerState; // é è¨ˆçš„æ–°ç‹€æ…‹
                
                if (newState) {
                    // å¾ OFF -> ON
                    wateringStartTime = new Date(); // è¨˜éŒ„é–‹å§‹æ™‚é–“
                    showCustomMessage(`å·²é–‹å•Ÿç‘æ°´ï¼è«‹åœ¨çµæŸæ™‚é»æ“ŠæŒ‰éˆ•é—œé–‰ã€‚`);
                } else {
                    // å¾ ON -> OFF (è¨˜éŒ„ç‘æ°´)
                    const endTime = new Date();
                    const durationSeconds = (endTime.getTime() - wateringStartTime.getTime()) / 1000;
                    
                    // ç•°æ­¥å¯«å…¥ç´€éŒ„
                    writeWateringLog(durationSeconds, location); 
                    
                    wateringStartTime = null; // æ¸…é™¤é–‹å§‹æ™‚é–“
                    showCustomMessage(`ç‘æ°´å·²é—œé–‰ï¼æ™‚é•· ${durationSeconds.toFixed(1)} ç§’ï¼Œç´€éŒ„å·²å„²å­˜ã€‚`);
                }
                
                // æ›´æ–°å‰ç«¯ç‹€æ…‹ (æœ€ä½³åšæ³•æ˜¯å¾ fetchData ç²å–çœŸå¯¦ç‹€æ…‹ï¼Œä½†é€™è£¡å…ˆé æœŸæˆåŠŸ)
                updateSprinklerUI(newState);
                
            } catch (error) {
                console.error("Toggle error:", error);
                showCustomMessage('æ§åˆ¶å¤±æ•—ï¼šç„¡æ³•é€£ç·šåˆ° ESP32 æˆ–ä¼ºæœå™¨éŒ¯èª¤ã€‚');
            } finally {
                sprinklerButton.disabled = false;
            }
        }

        /**
         * @description æ ¹æ“šç‹€æ…‹æ›´æ–°ç‘æ°´é–‹é—œçš„ UI
         */
        function updateSprinklerUI(isSprinklerOn, isError = false) {
            sprinklerState = isSprinklerOn;
            
            // æ¸…é™¤ç¾æœ‰çš„ç‹€æ…‹é¡åˆ¥
            sprinklerStatusDisplay.classList.remove('bg-green-600', 'bg-red-600', 'bg-gray-400');
            sprinklerButton.classList.remove('sprinkler-on', 'sprinkler-off');

            if (isError) {
                sprinklerStatusDisplay.textContent = 'é€£ç·šéŒ¯èª¤';
                sprinklerStatusDisplay.classList.add('bg-gray-400', 'text-white');
                sprinklerButton.textContent = 'ç„¡æ³•æ§åˆ¶';
                sprinklerButton.disabled = true;
            } else if (isSprinklerOn) {
                sprinklerStatusDisplay.textContent = 'é‹ä½œä¸­ (ON)';
                sprinklerStatusDisplay.classList.add('bg-green-600', 'text-white');
                sprinklerButton.textContent = 'é»æ“Šé—œé–‰ç‘æ°´ä¸¦è¨˜éŒ„';
                sprinklerButton.classList.add('sprinkler-off');
            } else {
                sprinklerStatusDisplay.textContent = 'é—œé–‰ (OFF)';
                sprinklerStatusDisplay.classList.add('bg-red-600', 'text-white');
                sprinklerButton.textContent = 'é»æ“Šé–‹å•Ÿç‘æ°´';
                sprinklerButton.classList.add('sprinkler-on');
            }
        }
        
        /**
         * @description æ›´æ–°æ°£å€™é¡¯ç¤ºå€çš„å…§å®¹
         * @param {string} location - ä½ç½®è³‡è¨Š
         * @param {string} weather - å¤©æ°£æ‘˜è¦
         */
        function updateClimateDisplay(location, weather) {
            if (location) {
                locationElement.textContent = `ä½ç½®: ${location}`;
            }
            if (weather) {
                weatherElement.textContent = `æ°£å€™: ${weather}`;
            }
        }
        
        // --- 7. è¼”åŠ©å‡½å¼ (è‡ªå®šç¾©è¨Šæ¯æ¡†æ›¿ä»£ alert) ---
        function showCustomMessage(message) {
            // åœ¨é€™è£¡å¯¦ç¾ä¸€å€‹ç°¡å–®çš„ UI å½ˆå‡ºé€šçŸ¥ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ alert()
            // ç”±æ–¼é€™æ˜¯æ¼”ç¤ºï¼Œæˆ‘å€‘æš«æ™‚ä½¿ç”¨ console.log æ›¿ä»£
            console.log(`[é€šçŸ¥]: ${message}`);
            
            // å¯¦éš›ç”¢å“ä¸­ï¼Œæ‚¨æœƒåœ¨é€™è£¡æ·»åŠ ä¸€å€‹ Tailwind CSS æ¨£å¼çš„è¨Šæ¯æ¡†
            const oldNotification = document.getElementById('notification-box');
            if (oldNotification) oldNotification.remove();

            const notification = document.createElement('div');
            notification.id = 'notification-box';
            notification.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white p-3 rounded-lg shadow-2xl z-50 transition duration-300 opacity-0';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '1';
            }, 50);

            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // --- 8. å•Ÿå‹•ç¨‹åº ---
        window.onload = () => {
            initFirebase();
            // é è¨­å…ˆé¡¯ç¤ºé è¨­ä½ç½®ï¼Œç¨å¾Œç”± Geolocation æˆ–ç´€éŒ„æ›´æ–°
            updateClimateDisplay(LOCATION_DEFAULT, 'æ­£åœ¨æŸ¥è©¢...');
            getGeolocation(); 
            fetchData();
            // æ¯ 10 ç§’è‡ªå‹•åˆ·æ–°ä¸€æ¬¡æ•¸æ“š
            refreshInterval = setInterval(fetchData, 10000); 
        };
        
        window.onbeforeunload = () => {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        };

    </script>
</body>
</html>
